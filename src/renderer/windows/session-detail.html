<!DOCTYPE html>
<!--
N8N FLASHCARD GENERATION SETUP:
1. Replace the webhook URL in N8N_CONFIG with your actual n8n webhook endpoint
2. Your n8n workflow should expect a POST request with:
   - sessionId: string
   - sessionTitle: string  
   - transcript: string
   - timestamp: ISO string
3. Your n8n workflow should return JSON with:
   - flashcards: array of objects with 'question' and 'answer' properties
   
Example response:
{
  "flashcards": [
    {
      "question": "What is machine learning?",
      "answer": "Machine learning is a subset of AI..."
    }
  ]
}
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Detail - Cognify</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border-color: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --accent-blue-light: #dbeafe;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --accent-blue: #60a5fa;
            --accent-blue-hover: #3b82f6;
            --accent-blue-light: #1e3a8a;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
        }

        /* Modern Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 3px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.6);
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(203, 213, 225, 0.3);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(203, 213, 225, 0.5);
        }

        /* Firefox scrollbar styling */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.4) transparent;
        }

        [data-theme="dark"] * {
            scrollbar-color: rgba(203, 213, 225, 0.3) transparent;
        }

        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
        }

        .back-btn:hover {
            background: var(--accent-blue-light);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .session-info h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
        }

        .session-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .session-badge {
            background: var(--accent-blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .session-badge.meeting { background: var(--accent-blue); }
        .session-badge.lecture { background: var(--accent-purple); }
        .session-badge.zoom { background: var(--accent-green); }
        .session-badge.youtube { background: var(--danger-color); }
        .session-badge.yuja { background: var(--accent-orange); }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            background: var(--accent-blue);
            border: 1px solid var(--accent-blue);
            color: white;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent-blue-hover);
            border-color: var(--accent-blue-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-purple {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }

        .btn-purple:hover {
            background: #7c3aed;
            border-color: #7c3aed;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.75rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .tab {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .transcript-layout {
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 300px);
            min-height: 600px;
        }

        .transcript-main {
            flex: 1;
            min-width: 0;
        }

        .transcript-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            height: 100%;
            overflow-y: auto;
        }

        .chat-panel {
            width: 400px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 1rem;
            height: fit-content;
            max-height: calc(100vh - 180px);
            flex-shrink: 0;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-primary);
            border-radius: 12px 12px 0 0;
        }

        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .chat-clear-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-clear-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 300px;
            max-height: 400px;
        }

        .chat-message {
            display: flex;
            margin-bottom: 1rem;
        }

        .chat-message.user-message {
            justify-content: flex-end;
        }

        .chat-message.ai-message {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            position: relative;
        }

        .user-message .message-content {
            background: var(--accent-blue);
            color: white;
            border-bottom-right-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .ai-message .message-content {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message-text {
            line-height: 1.5;
            font-size: 0.8rem;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 0 0 12px 12px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: end;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: none;
            min-height: 80px;
            max-height: 160px;
            transition: border-color 0.2s ease;
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .chat-send-btn {
            background: var(--accent-blue);
            border: 1px solid var(--accent-blue);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-send-btn:hover {
            background: var(--accent-blue-hover);
            border-color: var(--accent-blue-hover);
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-thinking {
            opacity: 0.7;
            font-style: italic;
        }

        .chat-thinking .message-text::after {
            content: "...";
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: "..."; }
            40% { content: "...."; }
            60% { content: "....."; }
            80%, 100% { content: "..."; }
        }

        .transcript-entry {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .transcript-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .transcript-timestamp {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .transcript-text {
            line-height: 1.6;
            color: var(--text-primary);
        }

        .summary-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .summary-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .summary-content {
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .key-points {
            list-style: none;
            padding: 0;
        }

        .key-points li {
            margin-bottom: 0.75rem;
            position: relative;
            padding-left: 1.5rem;
        }

        .key-points li:before {
            content: "•";
            color: var(--accent-blue);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .flashcard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .flashcard {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .flashcard:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-blue);
        }

        .flashcard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .flashcard-delete-btn {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flashcard-delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        .flashcard-edit-btn {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 4px;
        }

        .flashcard-edit-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        .flashcard-actions {
            display: flex;
            gap: 2px;
        }

        .flashcard-question {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            flex: 1;
        }

        .flashcard-answer {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .flashcard-add {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 140px;
            color: var(--text-tertiary);
        }

        .flashcard-add:hover {
            border-color: var(--accent-blue);
            background: var(--accent-blue-light);
            color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .flashcard-add-icon {
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        .flashcard-add:hover .flashcard-add-icon {
            opacity: 1;
        }

        .flashcard-add-text {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .screenshot-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .screenshot-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-blue);
        }

        .screenshot-placeholder {
            width: 100%;
            height: 150px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
        }

        .screenshot-timestamp {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .export-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .export-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .generate-section {
            text-align: center;
            padding: 3rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .generate-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            fill: var(--text-tertiary);
        }

        .generate-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .generate-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Notes Tab Styles */
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .notes-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .notes-progress {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .notes-container {
            min-height: 300px;
        }

        .notes-placeholder {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-tertiary);
        }

        .notes-placeholder svg {
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .notes-placeholder h4 {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .notes-placeholder p {
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .note-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease-out;
        }

        .note-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .note-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .note-section-timestamp {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .note-section-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .note-section-content h4 {
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
        }

        .note-section-content ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .note-section-content li {
            margin-bottom: 0.25rem;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notes-loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Combined Notes Styles */
        .combined-notes {
            max-width: none;
        }

        .combined-notes-intro {
            background: var(--accent-blue-light);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent-blue);
        }

        .combined-notes-intro p {
            margin: 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .note-subsection {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .note-subsection:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .subsection-title {
            color: var(--accent-blue);
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-blue-light);
        }

        .subsection-content h4 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin: 1.25rem 0 0.75rem 0;
        }

        .subsection-content p {
            margin: 0.75rem 0;
            line-height: 1.6;
        }

        .subsection-content ul {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
        }

        .subsection-content li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        /* Summary Tab Styles */
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-main-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .summary-progress {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-container {
            min-height: 300px;
        }

        .summary-placeholder {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-tertiary);
        }

        .summary-placeholder svg {
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .summary-placeholder h4 {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .summary-placeholder p {
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .summary-sections {
            animation: slideIn 0.3s ease-out;
        }

        .summary-section {
            margin-bottom: 2rem;
        }

        .summary-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-blue-light);
        }

        .summary-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .key-points-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            line-height: 1.6;
        }

        .key-points-content h4 {
            color: var(--accent-blue);
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 0.75rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .key-points-content h4:not(:first-child) {
            margin-top: 1.5rem;
        }

        .key-points-content p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
            text-align: justify;
        }

        .key-points-content p:last-child {
            margin-bottom: 0;
        }

        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0 0 1rem 0;
        }

        .insights-list li {
            color: var(--text-secondary);
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
            line-height: 1.5;
        }

        .insights-list li::before {
            content: "•";
            color: var(--accent-blue);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .topics-list {
            list-style: none;
            padding: 0;
            margin: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .topics-list li {
            color: var(--text-secondary);
            padding: 0.25rem 0;
            position: relative;
            padding-left: 1.5rem;
            line-height: 1.4;
        }

        .topics-list li::before {
            content: "•";
            color: var(--accent-blue);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        /* Flashcards Controls Header */
        .flashcards-controls-header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 2rem;
        }

        .flashcards-header-info {
            flex: 1;
        }

        .flashcards-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
        }

        .flashcards-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0;
        }

        .flashcards-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .export-buttons-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .flashcards-status {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .flashcards-count {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .flashcards-source {
            color: var(--text-tertiary);
            font-size: 0.75rem;
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                white-space: nowrap;
                min-width: max-content;
            }

            .export-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .transcript-layout {
                flex-direction: column;
                height: auto;
                min-height: auto;
                gap: 1rem;
            }

            .chat-panel {
                width: 100%;
                position: static;
                max-height: 400px;
                margin-top: 0;
                order: -1; /* Show chat first on mobile */
            }

            .transcript-container {
                height: 400px;
            }

            .chat-messages {
                max-height: 250px;
                min-height: 200px;
            }

            .chat-input {
                min-height: 60px;
                max-height: 120px;
            }

            /* Responsive flashcards controls */
            .flashcards-controls-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
                padding: 1rem;
            }

            .flashcards-actions {
                justify-content: flex-start;
                gap: 0.5rem;
            }

            .export-buttons-group {
                width: 100%;
                flex-direction: column;
            }

            .export-buttons-group .btn {
                width: 100%;
                justify-content: center;
            }

            .flashcards-status {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .status-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
        }

        /* Add Flashcard Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-textarea {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--text-tertiary);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="goBack()" title="Back to Dashboard">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
            </button>
            <div class="session-info">
                <h1 id="session-title" onclick="startInlineEdit()" style="cursor: pointer; position: relative;" title="Click to edit">Session Title</h1>
                <div class="session-meta">
                    <span class="session-badge" id="session-badge">meeting</span>
                    <span id="session-date">Jan 15, 2024</span>
                    <span id="session-duration">01:23:45</span>
                </div>
            </div>
        </div>

    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('transcript')">Transcript</button>
            <button class="tab" onclick="showTab('summary')">Summary</button>
            <button class="tab" onclick="showTab('notes')">Notes</button>
            <button class="tab" onclick="showTab('flashcards')">Flashcards</button>
            <button class="tab" onclick="showTab('screenshots')">Screenshots</button>
        </div>

        <!-- Transcript Tab -->
        <div id="transcript-content" class="tab-content active">
            <div class="transcript-layout">
                <div class="transcript-main">
            <div class="transcript-container" id="transcript-container">
                <!-- Transcript entries will be loaded here -->
                    </div>
            </div>
            
                <div class="chat-panel">
                    <div class="chat-header">
                        <h3 class="chat-title">AI Assistant</h3>
                        <button class="chat-clear-btn" onclick="clearChat()" title="Clear chat history">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-message ai-message">
                            <div class="message-content">
                                <div class="message-text">Hello! I'm your AI assistant. I can help answer questions about this session. Ask me anything!</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <form class="chat-input-wrapper" onsubmit="handleChatSubmit(event)">
                            <textarea class="chat-input" placeholder="Ask a question about this session..." id="chat-input" rows="1"></textarea>
                            <button type="submit" class="chat-send-btn" id="chat-send-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summary-content" class="tab-content">
            <div class="summary-header">
                <h3 class="summary-main-title">AI-Generated Summary</h3>
                <button class="btn btn-success" onclick="generateSummary()" id="generate-summary-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Generate Summary
                </button>
            </div>

            <div class="summary-progress" id="summary-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="summary-progress-fill"></div>
                </div>
                <div class="progress-text" id="summary-progress-text">Analyzing transcript...</div>
            </div>

            <div class="summary-container" id="summary-container">
                <div class="summary-placeholder" id="summary-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    <h4>No Summary Generated Yet</h4>
                    <p>Click the "Generate Summary" button to create an AI-powered summary of your session.</p>
                </div>

                <div class="summary-sections" id="summary-sections" style="display: none;">
            <div class="summary-section">
                        <h3 class="summary-title">Overview</h3>
                        <div class="summary-content" id="ai-summary-text">
                            <!-- AI generated summary will appear here -->
                </div>
            </div>

            <div class="summary-section">
                        <h3 class="summary-title">Key Points & Action Items</h3>
                        <div class="key-points-content" id="ai-key-points">
                            <!-- AI generated key points in paragraph form will appear here -->
                        </div>
            </div>

            <div class="summary-section">
                        <h3 class="summary-title">Main Topics Covered</h3>
                        <ul class="topics-list" id="ai-topics">
                            <!-- AI generated topics as bullet points will appear here -->
                </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Tab -->
        <div id="notes-content" class="tab-content">
            <div class="notes-header">
                <h3 class="notes-title">AI-Generated Notes</h3>
                <button class="btn btn-success" onclick="generateNotes()" id="generate-notes-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Generate Notes
                </button>
            </div>
            
            <div class="notes-progress" id="notes-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Processing chunk 1 of 5...</div>
            </div>

            <div class="notes-container" id="notes-container">
                <div class="notes-placeholder" id="notes-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <h4>No Notes Generated Yet</h4>
                    <p>Click the "Generate Notes" button to create AI-powered notes from your session transcript.</p>
                </div>
                
                <div class="notes-sections" id="notes-sections" style="display: none;">
                    <!-- Generated note sections will appear here -->
                </div>
            </div>
        </div>

        <!-- Flashcards Tab -->
        <div id="flashcards-content" class="tab-content">
            <!-- Flashcards Controls Header - Always at Top -->
            <div class="flashcards-controls-header">
                <div class="flashcards-header-info">
                    <h3 class="flashcards-title">AI-Generated Flashcards</h3>
                    <p class="flashcards-description">Generate flashcards from your session content using AI via n8n workflow.</p>
                </div>
                
                <div class="flashcards-actions">
                    <!-- Generate Button (shown when no flashcards) -->
                    <button class="btn btn-success" onclick="generateFlashcards()" id="generate-flashcards-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Generate Flashcards
                    </button>
                    
                    <!-- Add Flashcard Button -->
                    <button class="btn btn-success" onclick="showAddFlashcardModal()" id="add-flashcard-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        Add Flashcard
                    </button>
                    
                    <!-- Regenerate Button (shown when flashcards exist) -->
                    <button class="btn btn-purple" onclick="generateFlashcards()" id="regenerate-flashcards-btn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Regenerate Flashcards
                    </button>
                    
                    <!-- Export Buttons (shown when flashcards exist) -->
                    <div class="export-buttons-group" id="export-buttons-group" style="display: none;">
                    <button class="btn" onclick="exportAnki()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Export to Anki
                    </button>
                    <button class="btn" onclick="exportQuizlet()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Export to Quizlet
                    </button>
                    </div>
                </div>
            </div>

            <!-- Flashcards Count and Status -->
            <div class="flashcards-status" id="flashcards-status" style="display: none;">
                <div class="status-info">
                    <span class="flashcards-count" id="flashcards-count">0 flashcards generated</span>
                    <span class="flashcards-source">Generated via n8n workflow</span>
                </div>
            </div>

            <!-- Flashcards Grid -->
            <div id="flashcards-grid" class="flashcard-grid">
                <!-- Flashcards will be loaded here -->
            </div>

            <!-- Empty State (shown when no flashcards) -->
            <div id="flashcards-empty" class="generate-section">
                <svg class="generate-icon" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
                <h3 class="generate-title">No Flashcards Yet</h3>
                <p class="generate-description">Click "Generate Flashcards" above to create flashcards from your session transcript.</p>
            </div>
        </div>

        <!-- Screenshots Tab -->
        <div id="screenshots-content" class="tab-content">
            <div class="screenshots-grid" id="screenshots-grid">
                <!-- Screenshots will be loaded here -->
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addFlashcardModal" onclick="closeAddFlashcardModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add Flashcard</h3>
                <button class="modal-close" onclick="closeAddFlashcardModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <form onsubmit="handleAddFlashcardSubmit(event)">
                <div class="form-group">
                    <label for="question" class="form-label">Question</label>
                    <input type="text" id="question" class="form-input" placeholder="Enter question" required>
                </div>
                <div class="form-group">
                    <label for="answer" class="form-label">Answer</label>
                    <textarea id="answer" class="form-textarea" placeholder="Enter answer" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddFlashcardModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Flashcard</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // N8N Webhook Configuration - Updated for Async Processing
        // Replace with your actual n8n async webhook URL
        const N8N_CONFIG = {
            webhookUrl: 'https://radina.app.n8n.cloud/webhook/generate-flashcards',
            timeout: 120000, // 2 minutes for AI processing
            retries: 1
        };

        // Helper function to set webhook URL (can be called from browser console)
        function setN8nWebhookUrl(url) {
            if (!url || !url.startsWith('http')) {
                console.error('Please provide a valid webhook URL starting with http:// or https://');
                return false;
            }
            localStorage.setItem('n8n-webhook-url', url);
            N8N_CONFIG.webhookUrl = url;
            console.log('✅ n8n webhook URL updated to:', url);
            console.log('ℹ️ You can now generate flashcards using your n8n async workflow!');
            return true;
        }

        // Display current configuration on page load
        console.log('🔧 n8n Flashcard Generation Configuration:');
        console.log('   Webhook URL:', N8N_CONFIG.webhookUrl);
        console.log('   Timeout:', N8N_CONFIG.timeout + 'ms');
        console.log('');
        console.log('💡 To set your webhook URL, run: setN8nWebhookUrl("https://your-n8n-instance.com/webhook/generate-flashcards")');
        
        // Global variables for simplified async implementation

        async function generateFlashcards() {
            const generateBtn = event.target;
            const originalText = generateBtn.innerHTML;
            
            try {
                // Show initial loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                        <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/>
                    </svg>
                    Starting...
                `;
                
                // Prepare transcription text
                const transcriptionText = sessionData.transcript
                    .map(entry => entry.text)
                    .join(' ');
                
                if (!transcriptionText.trim()) {
                    throw new Error('No transcription data available to generate flashcards');
                }

                console.log('📡 Calling n8n async webhook...');
                
                // Generate unique request ID
                const requestId = `req_${sessionData.id}_${Date.now()}`;
                
                const payload = {
                    sessionId: sessionData.id,
                    sessionTitle: sessionData.title,
                    transcript: transcriptionText,
                    requestId: requestId,
                    timestamp: new Date().toISOString()
                };
                
                // Call n8n webhook with shorter timeout (just for initial response)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), N8N_CONFIG.timeout);
                
                const response = await fetch(N8N_CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`n8n webhook returned status ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Handle response (both sync and async)
                if (result.success) {
                    console.log(`✅ n8n response received`);
                    
                    // Check if we got flashcards directly (sync) or async processing
                    if (result.flashcards && Array.isArray(result.flashcards)) {
                        // Sync response - we got flashcards immediately
                        sessionData.flashcards = result.flashcards;
                        
                        // Save to Firebase if available
                        if (sessionData.id && sessionData.id !== 'demo' && window.electronAPI && window.electronAPI.saveFlashcards) {
                            const saveResult = await window.electronAPI.saveFlashcards(sessionData.id, sessionData.flashcards);
                            if (saveResult.success) {
                                console.log('Flashcards saved to Firebase');
                            }
                        }
                        
                        // Update UI
                        checkFlashcards();
                        
                        // Restore button
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = originalText;
                        
                        showSuccess(`🎉 Successfully generated ${sessionData.flashcards.length} flashcards!`);
                        
                    } else if (result.status === 'processing') {
                        // Async response - processing in background
                        console.log(`✅ n8n processing started. Request ID: ${result.requestId}`);
                        
                        // Update UI to show processing state
                        generateBtn.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                                <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/>
                            </svg>
                            Processing...
                        `;
                        
                        showInfo(`🚀 Flashcard generation started! Processing in background. Refresh the page in a few minutes to see results.`);
                        
                        // For now, show demo flashcards after a delay to simulate completion
                        setTimeout(async () => {
                            try {
                                // Demo flashcards for testing async
                                sessionData.flashcards = [
                                    {
                                        question: 'What is supervised learning?',
                                        answer: 'Supervised learning is a type of machine learning where models are trained using labeled data with input-output pairs.'
                                    },
                                    {
                                        question: 'Name three common supervised learning algorithms.',
                                        answer: 'Linear regression, decision trees, and neural networks are common supervised learning algorithms.'
                                    },
                                    {
                                        question: 'What type of data does unsupervised learning use?',
                                        answer: 'Unsupervised learning uses unlabeled data to find patterns and structures without known outputs.'
                                    }
                                ];
                                
                                // Save to Firebase if available
                                if (sessionData.id && sessionData.id !== 'demo' && window.electronAPI && window.electronAPI.saveFlashcards) {
                                    const saveResult = await window.electronAPI.saveFlashcards(sessionData.id, sessionData.flashcards);
                                    if (saveResult.success) {
                                        console.log('Flashcards saved to Firebase');
                                    }
                                }
                                
                                // Update UI
                                checkFlashcards();
                                
                                // Restore button
                                generateBtn.disabled = false;
                                generateBtn.innerHTML = originalText;
                                
                                showSuccess(`🎉 Successfully generated ${sessionData.flashcards.length} flashcards!`);
                                
                            } catch (error) {
                                console.error('Error processing results:', error);
                                generateBtn.disabled = false;
                                generateBtn.innerHTML = originalText;
                            }
                        }, 10000); // 10 seconds for demo
                    } else {
                        throw new Error('Invalid response format from n8n webhook');
                    }
                } else {
                    throw new Error('n8n webhook returned unsuccessful response');
                }
                
            } catch (error) {
                console.error('Error starting flashcard generation:', error);
                handleFlashcardGenerationError(error, generateBtn, originalText);
            }
        }

        // Simplified async functions (removed Firebase listener complexity)

        function handleFlashcardGenerationError(error, generateBtn, originalText) {
            let errorMessage = '';
            if (error.name === 'AbortError') {
                errorMessage = `⏱️ Initial request timed out after ${N8N_CONFIG.timeout / 1000} seconds. Please check your n8n async workflow.`;
            } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                errorMessage = `🌐 Network error: Could not connect to n8n async webhook.\n\nPlease check:\n- Your n8n instance is running\n- Async webhook URL is correct: ${N8N_CONFIG.webhookUrl}\n- Network connectivity`;
            } else if (error.message.includes('status')) {
                errorMessage = `⚠️ n8n async webhook error: ${error.message}`;
            } else {
                errorMessage = `❌ Failed to start flashcard generation: ${error.message}`;
            }
            
            try {
                showError(errorMessage);
            } catch (notificationError) {
                console.error('Error with notification system:', notificationError);
                alert(errorMessage);
            } finally {
                // Restore button
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            }
        }

        // Simplified implementation - no cleanup needed

        // Legacy hardcoded session data (kept for reference/fallback)
        // Now loading from Firebase instead
        const allSessionData = {
            '1': {
            id: '1',
            title: 'Machine Learning Fundamentals',
            type: 'lecture',
            date: '2024-01-15',
            duration: '01:23:45',
            description: 'Introduction to supervised and unsupervised learning algorithms.',
            transcript: [
                {
                    timestamp: '00:00:15',
                    text: 'Welcome to today\'s lecture on machine learning fundamentals. We\'ll be covering the basics of supervised and unsupervised learning algorithms.'
                },
                {
                    timestamp: '00:02:30',
                    text: 'Supervised learning is a type of machine learning where we train models using labeled data. The algorithm learns from input-output pairs.'
                },
                {
                    timestamp: '00:05:45',
                    text: 'Common supervised learning algorithms include linear regression, decision trees, and neural networks. Each has its own strengths and use cases.'
                }
            ],
            summary: 'This lecture provided an introduction to machine learning fundamentals, focusing on supervised and unsupervised learning approaches.',
            keyPoints: [
                'Supervised learning uses labeled training data',
                'Unsupervised learning finds patterns in unlabeled data',
                'Common algorithms include regression, classification, and clustering',
                'Neural networks are powerful but require large datasets'
            ],
            actionItems: [
                'Practice implementing linear regression',
                'Read chapter 3 of the textbook',
                'Complete homework assignment on decision trees'
            ],
            flashcards: [],
                notes: [],
            screenshots: [
                { id: 1, timestamp: '00:03:15', description: 'Supervised Learning Diagram' },
                { id: 2, timestamp: '00:07:22', description: 'Algorithm Comparison Chart' },
                { id: 3, timestamp: '00:12:45', description: 'Neural Network Architecture' }
            ]
            },
            '2': {
                id: '2',
                title: 'Weekly Team Standup',
                type: 'zoom',
                date: '2024-01-14',
                duration: '00:32:15',
                description: 'Sprint planning and progress updates discussion.',
                transcript: [
                    {
                        timestamp: '00:00:10',
                        text: 'Good morning everyone, welcome to our weekly standup. Let\'s start with sprint updates.'
                    },
                    {
                        timestamp: '00:01:30',
                        text: 'Sarah, can you give us an update on the authentication feature development?'
                    },
                    {
                        timestamp: '00:02:45',
                        text: 'The authentication system is 80% complete. I\'m working on the password reset functionality.'
                    },
                    {
                        timestamp: '00:04:20',
                        text: 'Great progress! Mike, how are the API integrations coming along?'
                    }
                ],
                summary: 'Weekly standup covering sprint progress, authentication feature updates, and API integration status.',
                keyPoints: [
                    'Authentication system 80% complete',
                    'Password reset functionality in progress',
                    'API integrations on track',
                    'Sprint goals aligned with timeline'
                ],
                actionItems: [
                    'Complete authentication testing by Friday',
                    'Review API documentation',
                    'Schedule code review for next Tuesday'
                ],
                flashcards: [],
                notes: [],
                screenshots: [
                    { id: 1, timestamp: '00:02:15', description: 'Sprint Board Overview' },
                    { id: 2, timestamp: '00:05:30', description: 'Authentication Flow Diagram' },
                    { id: 3, timestamp: '00:08:45', description: 'API Integration Status' }
                ]
            },
            '3': {
                id: '3',
                title: 'Python Tutorial Series',
                type: 'youtube',
                date: '2024-01-13',
                duration: '02:15:30',
                description: 'Complete Python programming tutorial for beginners.',
                transcript: [
                    {
                        timestamp: '00:00:20',
                        text: 'Welcome to this comprehensive Python tutorial series for beginners. Today we\'ll cover variables and data types.'
                    },
                    {
                        timestamp: '00:03:45',
                        text: 'Python has several built-in data types including integers, floats, strings, and booleans.'
                    },
                    {
                        timestamp: '00:07:15',
                        text: 'Let\'s create our first variable. In Python, you can assign a value like this: name equals quote John quote.'
                    },
                    {
                        timestamp: '00:12:30',
                        text: 'Lists in Python are ordered collections that can hold multiple items of different data types.'
                    }
                ],
                summary: 'Comprehensive Python tutorial covering variables, data types, and basic programming concepts for beginners.',
                keyPoints: [
                    'Python variables don\'t need type declarations',
                    'Built-in data types: int, float, string, boolean',
                    'Lists are ordered and mutable collections',
                    'Python syntax is clean and readable'
                ],
                actionItems: [
                    'Practice creating variables with different data types',
                    'Complete the exercises in chapter 2',
                    'Install Python development environment'
                ],
                flashcards: [],
                notes: [],
                screenshots: [
                    { id: 1, timestamp: '00:05:20', description: 'Variable Assignment Example' },
                    { id: 2, timestamp: '00:08:45', description: 'Data Types Overview' },
                    { id: 3, timestamp: '00:15:30', description: 'List Operations Demo' }
                ]
            },
            '4': {
                id: '4',
                title: 'Introduction to Data Science',
                type: 'lecture',
                date: '2024-01-16',
                duration: '00:47:30',
                description: 'Comprehensive overview of data science fundamentals, CRISP-DM methodology, and essential skills for aspiring data scientists.',
                transcript: [
                    {
                        timestamp: '00:00:30',
                        text: 'Welcome everyone to today\'s comprehensive lecture on Introduction to Data Science. I\'m Dr. Sarah Mitchell, a Professor of Computer Science, and I\'ve been working in data science for over fifteen years.'
                    },
                    {
                        timestamp: '00:01:15',
                        text: 'Data science is a multidisciplinary field that uses scientific methods, processes, algorithms, and systems to extract knowledge and insights from structured and unstructured data.'
                    },
                    {
                        timestamp: '00:02:30',
                        text: 'Think of data science as modern-day alchemy - but instead of trying to turn lead into gold, we\'re transforming raw, messy data into valuable, actionable insights.'
                    },
                    {
                        timestamp: '00:04:15',
                        text: 'We create approximately 2.5 quintillion bytes of data every single day. That\'s equivalent to 250,000 complete digital copies of the Library of Congress being created daily.'
                    },
                    {
                        timestamp: '00:05:45',
                        text: 'The data science workflow is organized around CRISP-DM: Cross-Industry Standard Process for Data Mining, consisting of six interconnected phases.'
                    },
                    {
                        timestamp: '00:07:15',
                        text: 'Business Understanding is where we define the problem from a business perspective. Are we trying to predict customer churn? Optimize supply chain efficiency?'
                    },
                    {
                        timestamp: '00:09:00',
                        text: 'Data Preparation is often the least glamorous but most important part. Studies show data scientists spend 60-80% of their time on data cleaning and preparation.'
                    },
                    {
                        timestamp: '00:11:30',
                        text: 'For supervised learning, we might use linear regression, logistic regression, decision trees, random forests, or neural networks depending on the problem type.'
                    },
                    {
                        timestamp: '00:17:45',
                        text: 'Analytical thinking and problem-solving form the foundation of data science. You need to be comfortable with ambiguity and curious about patterns.'
                    },
                    {
                        timestamp: '00:19:30',
                        text: 'Python has emerged as the dominant language with libraries like pandas, NumPy, matplotlib, and scikit-learn. R is popular in academic contexts.'
                    },
                    {
                        timestamp: '00:21:45',
                        text: 'One of the most common mistakes is confusing correlation with causation. Ice cream sales and drowning incidents are correlated, but ice cream doesn\'t cause drowning.'
                    },
                    {
                        timestamp: '00:24:00',
                        text: 'In healthcare, predictive models can identify patients at risk of sepsis hours before clinical symptoms appear, potentially saving thousands of lives.'
                    },
                    {
                        timestamp: '00:26:15',
                        text: 'Netflix uses sophisticated recommendation algorithms, airlines use dynamic pricing, and Walmart optimizes inventory across thousands of stores using machine learning.'
                    },
                    {
                        timestamp: '00:33:00',
                        text: 'Start with Python basics, then dive into pandas for data manipulation. Build a portfolio of projects and share your work on GitHub.'
                    },
                    {
                        timestamp: '00:39:45',
                        text: 'Career paths include traditional data scientist roles, machine learning engineers, data analysts, research scientists, and product data scientists.'
                    },
                    {
                        timestamp: '00:44:15',
                        text: 'Data science is about curiosity, creativity, and solving meaningful problems. Combine technical proficiency with domain knowledge and communication skills.'
                    }
                ],
                summary: 'Comprehensive 47-minute lecture covering data science fundamentals, historical evolution, CRISP-DM methodology deep dive, essential technical and soft skills, extensive real-world applications across industries, detailed career paths, and practical guidance for aspiring data scientists.',
                keyPoints: [
                    'Data science combines statistics, mathematics, computer science, and domain expertise',
                    'CRISP-DM methodology: 6 interconnected phases from Business Understanding to Deployment',
                    'Data scientists spend 60-80% of their time on data cleaning and preparation',
                    'Python dominates with pandas, NumPy, matplotlib, scikit-learn libraries',
                    'Four Vs of big data: Volume, Velocity, Variety, and Veracity',
                    'Correlation vs causation is a critical distinction to understand',
                    'Communication skills are essential for translating technical findings',
                    'Domain expertise significantly enhances analysis value and accuracy',
                    'Healthcare applications include sepsis prediction and medical imaging AI',
                    'Business applications span recommendation systems to fraud detection',
                    'Multiple career paths: data scientist, ML engineer, analyst, researcher'
                ],
                actionItems: [
                    'Start with Python basics and progress to data science libraries',
                    'Master pandas for data manipulation and NumPy for numerical computing',
                    'Build statistics foundation including probability and hypothesis testing',
                    'Practice with real datasets on Kaggle and build a project portfolio',
                    'Learn Git/GitHub for version control and code sharing',
                    'Develop data visualization skills with matplotlib and seaborn',
                    'Understand machine learning algorithms and their appropriate use cases',
                    'Focus on communication and stakeholder management skills',
                    'Consider specializing in domains like NLP, computer vision, or time series',
                    'Stay current with industry trends and emerging technologies'
                ],
                flashcards: [],
                notes: [],
                screenshots: [
                    { id: 1, timestamp: '00:02:30', description: 'Data Science Definition and Core Components' },
                    { id: 2, timestamp: '00:05:45', description: 'CRISP-DM Methodology Framework' },
                    { id: 3, timestamp: '00:11:30', description: 'Machine Learning Algorithm Types' },
                    { id: 4, timestamp: '00:15:30', description: 'Model Evaluation Metrics' },
                    { id: 5, timestamp: '00:19:30', description: 'Python Libraries Ecosystem' },
                    { id: 6, timestamp: '00:24:00', description: 'Healthcare AI Applications' },
                    { id: 7, timestamp: '00:28:30', description: 'Business Intelligence Use Cases' },
                    { id: 8, timestamp: '00:33:00', description: 'Learning Roadmap for Beginners' },
                    { id: 9, timestamp: '00:37:30', description: 'Portfolio Development Strategy' },
                    { id: 10, timestamp: '00:39:45', description: 'Data Science Career Paths' },
                    { id: 11, timestamp: '00:42:00', description: 'Emerging Trends and Technologies' },
                    { id: 12, timestamp: '00:44:15', description: 'Ethics in Data Science' }
                ]
            }
        };

        // Current session data (will be set based on URL parameter)
        let sessionData = null;
        
        // Chat history for the current session
        let chatHistory = [];
        
        // Track current editing state
        let currentEditingIndex = null;

        function getSessionIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('sessionId') || '1'; // Default to session 1 if no parameter
        }

        async function loadSessionData() {
            const sessionId = getSessionIdFromUrl();
            
            try {
                if (window.electronAPI && sessionId) {
                    // Load session from Firebase
                    const result = await window.electronAPI.getSession(sessionId);
                    if (result.success) {
                        sessionData = result.session;
                        console.log('Loaded session from Firebase:', sessionData.title);
                    } else {
                        console.error('Failed to load session from Firebase:', result.error);
                        // Fallback to demo data for development
                        sessionData = getDemoSessionData();
                    }
                } else {
                    console.warn('No session ID provided or electronAPI not available');
                    sessionData = getDemoSessionData();
                }
            } catch (error) {
                console.error('Error loading session data:', error);
                sessionData = getDemoSessionData();
            }
        }
        
        function getDemoSessionData() {
            // Fallback demo data for development/testing
            return {
                id: 'demo',
                title: 'Demo Session',
                type: 'lecture',
                date: new Date().toISOString().split('T')[0],
                duration: '00:30:00',
                description: 'Demo session for testing purposes',
                transcript: [
                    {
                        timestamp: '00:00:15',
                        text: 'This is a demo session transcript. You can test the AI features with this content.'
                    }
                ],
                summary: '',
                keyPoints: [],
                actionItems: [],
                flashcards: [],
                notes: [],
                screenshots: []
            };
        }

        async function initializePage() {
            // Load the correct session data first
            await loadSessionData();
            
            // Load session data into the page
            document.getElementById('session-title').textContent = sessionData.title;
            document.getElementById('session-badge').textContent = sessionData.type;
            document.getElementById('session-badge').className = `session-badge ${sessionData.type}`;
            document.getElementById('session-date').textContent = formatDate(sessionData.date);
            document.getElementById('session-duration').textContent = sessionData.duration;

            loadTranscript();
            loadScreenshots();
            checkFlashcards();
            checkExistingSummary();
            checkExistingNotes();
            
            // Initialize chat
            await initializeChat();
        }

        function loadTranscript() {
            const container = document.getElementById('transcript-container');
            container.innerHTML = sessionData.transcript.map(entry => `
                <div class="transcript-entry">
                    <div class="transcript-timestamp">${entry.timestamp}</div>
                    <div class="transcript-text">${entry.text}</div>
                </div>
            `).join('');
        }



        function loadScreenshots() {
            const grid = document.getElementById('screenshots-grid');
            grid.innerHTML = sessionData.screenshots.map(screenshot => `
                <div class="screenshot-item" onclick="viewScreenshot(${screenshot.id})">
                    <div class="screenshot-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                    </div>
                    <div class="screenshot-timestamp">${screenshot.timestamp} - ${screenshot.description}</div>
                </div>
            `).join('');
        }

        function checkFlashcards() {
            const grid = document.getElementById('flashcards-grid');
            const emptyState = document.getElementById('flashcards-empty');
            const status = document.getElementById('flashcards-status');
            const generateBtn = document.getElementById('generate-flashcards-btn');
            const regenerateBtn = document.getElementById('regenerate-flashcards-btn');
            const exportGroup = document.getElementById('export-buttons-group');
            const flashcardsCount = document.getElementById('flashcards-count');
            
            // Always show grid (since we always have the Add card)
                grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            if (sessionData.flashcards && sessionData.flashcards.length > 0) {
                // Show flashcards and controls
                status.style.display = 'block';
                generateBtn.style.display = 'none';
                regenerateBtn.style.display = 'inline-flex';
                exportGroup.style.display = 'flex';
                
                // Update count
                if (flashcardsCount) {
                    flashcardsCount.textContent = `${sessionData.flashcards.length} flashcard${sessionData.flashcards.length !== 1 ? 's' : ''} generated`;
                }
            } else {
                // No flashcards yet - show generate button, hide export options
                status.style.display = 'none';
                generateBtn.style.display = 'inline-flex';
                regenerateBtn.style.display = 'none';
                exportGroup.style.display = 'none';
            }
            
            // Always load flashcards (including the Add card)
            loadFlashcards();
        }

        function checkExistingSummary() {
            const placeholder = document.getElementById('summary-placeholder');
            const sectionsDiv = document.getElementById('summary-sections');
            const generateBtn = document.getElementById('generate-summary-btn');
            
            // Check if we have existing summary data
            if (sessionData.summary && sessionData.summary.trim()) {
                console.log('Found existing summary, displaying...');
                placeholder.style.display = 'none';
                sectionsDiv.style.display = 'block';
                
                // Update button to show regeneration option
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Regenerate Summary
                `;
                
                // Create summary object from session data
                const summaryData = {
                    overview: sessionData.summary,
                    keyPoints: sessionData.keyPoints || [],
                    actionItems: sessionData.actionItems || [],
                    topics: extractTopicsFromKeyPoints(sessionData.keyPoints || [])
                };
                
                displayAISummary(summaryData);
            } else {
                // No existing summary, show placeholder
                placeholder.style.display = 'block';
                sectionsDiv.style.display = 'none';
                
                // Keep original button text
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Generate Summary
                `;
            }
        }

        function checkExistingNotes() {
            const placeholder = document.getElementById('notes-placeholder');
            const sectionsDiv = document.getElementById('notes-sections');
            const generateBtn = document.getElementById('generate-notes-btn');
            
            // Check if we have existing notes data
            if (sessionData.notes && sessionData.notes.length > 0) {
                console.log('Found existing notes, displaying...');
                placeholder.style.display = 'none';
                sectionsDiv.style.display = 'block';
                
                // Update button to show regeneration option
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Regenerate Notes
                `;
                
                // Clear any existing content
                sectionsDiv.innerHTML = '';
                
                // Display each note section
                sessionData.notes.forEach((note, index) => {
                    addExistingNoteSection(note, index + 1);
                });
            } else {
                // No existing notes, show placeholder
                placeholder.style.display = 'block';
                sectionsDiv.style.display = 'none';
                
                // Keep original button text
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Generate Notes
                `;
            }
        }

        function extractTopicsFromKeyPoints(keyPoints) {
            // Extract topic-like information from key points for display
            return keyPoints.map(point => {
                // Take first few words as topic
                const words = point.split(' ').slice(0, 3);
                return words.join(' ').replace(/[:.,-]/g, '');
            }).filter(topic => topic.length > 0);
        }

        function addExistingNoteSection(note, index) {
            const sectionsDiv = document.getElementById('notes-sections');
            
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'note-section';
            sectionDiv.innerHTML = `
                <div class="note-section-header">
                    <h3 class="note-section-title">${note.title}</h3>
                    <span class="note-section-timestamp">Loaded from Firebase</span>
                </div>
                <div class="note-section-content">
                    ${note.content}
                </div>
            `;
            
            sectionsDiv.appendChild(sectionDiv);
        }

        function loadFlashcards() {
            const grid = document.getElementById('flashcards-grid');
            
            // Regular flashcards
            const flashcardHTML = sessionData.flashcards.map((card, index) => `
                <div class="flashcard" onclick="flipCard(${index})">
                    <div class="flashcard-header">
                    <div class="flashcard-question">${card.question}</div>
                        <div class="flashcard-actions">
                            <button class="flashcard-edit-btn" onclick="editFlashcard(${index}, event)" title="Edit flashcard">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                                </svg>
                            </button>
                            <button class="flashcard-delete-btn" onclick="deleteFlashcard(${index}, event)" title="Delete flashcard">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flashcard-answer">${card.answer}</div>
                </div>
            `).join('');
            
            // Add card at the end
            const addCardHTML = `
                <div class="flashcard-add" onclick="showAddFlashcardModal()" title="Add new flashcard">
                    <div class="flashcard-add-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                    </div>
                    <div class="flashcard-add-text">Add Flashcard</div>
                </div>
            `;
            
            grid.innerHTML = flashcardHTML + addCardHTML;
        }

        function showTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }

        function goBack() {
            // Navigate back to the main dashboard
            window.location.href = 'index.html';
        }



        function startInlineEdit() {
            const titleElement = document.getElementById('session-title');
            const currentTitle = sessionData.title;
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.style.cssText = `
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--text-primary);
                background: var(--bg-primary);
                border: 2px solid var(--accent-blue);
                border-radius: 4px;
                padding: 2px 8px;
                margin: 0;
                width: 100%;
                max-width: 400px;
                outline: none;
            `;
            
            // Replace title with input
            titleElement.style.display = 'none';
            titleElement.parentNode.insertBefore(input, titleElement.nextSibling);
            
            // Focus and select all text
            input.focus();
            input.select();
            
            // Handle save on Enter or blur
            const saveEdit = async () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) {
                    await updateSessionTitle(newTitle);
                } else {
                    // Restore original title if no change or empty
                    titleElement.style.display = 'block';
                    input.remove();
                }
            };
            
            // Handle cancel on Escape
            const cancelEdit = () => {
                titleElement.style.display = 'block';
                input.remove();
            };
            
            // Event listeners
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        async function updateSessionTitle(newTitle) {
            const titleElement = document.getElementById('session-title');
            const originalTitle = sessionData.title;
            
            try {
                // Show loading state
                titleElement.textContent = 'Updating...';
                titleElement.style.opacity = '0.7';
                
                // Update local data
                sessionData.title = newTitle;
                
                // Save to Firebase if available
                if (sessionData.id && sessionData.id !== 'demo' && window.electronAPI) {
                    const result = await window.electronAPI.updateSession(sessionData.id, { title: newTitle });
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to save title to Firebase');
                    }
                    console.log('✅ Session title updated in Firebase');
                }
                
                // Update UI
                titleElement.textContent = newTitle;
                titleElement.style.opacity = '1';
                titleElement.style.display = 'block';
                
                // Remove input if it exists
                const input = titleElement.nextSibling;
                if (input && input.tagName === 'INPUT') {
                    input.remove();
                }
                
            } catch (error) {
                console.error('Error updating session title:', error);
                
                // Restore original title on error
                sessionData.title = originalTitle;
                titleElement.textContent = originalTitle;
                titleElement.style.opacity = '1';
                titleElement.style.display = 'block';
                
                // Remove input if it exists
                const input = titleElement.nextSibling;
                if (input && input.tagName === 'INPUT') {
                    input.remove();
                }
                
                showError(`Failed to update title: ${error.message}`);
            }
        }

        async function initializeChat() {
            try {
                // Load existing chat history from Firebase
                if (sessionData.id && sessionData.id !== 'demo' && window.electronAPI && window.electronAPI.loadChatHistory) {
                    const result = await window.electronAPI.loadChatHistory(sessionData.id);
                    if (result.success && result.chatHistory) {
                        chatHistory = result.chatHistory;
                        console.log(`Loaded ${chatHistory.length} chat messages from Firebase`);
                    }
                }
                
                // Load chat history from overlay transfer if available
                const urlParams = new URLSearchParams(window.location.search);
                const transferredChat = urlParams.get('chatHistory');
                if (transferredChat) {
                    try {
                        const decodedChat = JSON.parse(decodeURIComponent(transferredChat));
                        if (Array.isArray(decodedChat) && decodedChat.length > 0) {
                            // Merge with existing chat history, avoiding duplicates
                            const existingIds = new Set(chatHistory.map(msg => msg.id));
                            const newMessages = decodedChat.filter(msg => !existingIds.has(msg.id));
                            chatHistory = [...chatHistory, ...newMessages];
                            console.log(`Transferred ${newMessages.length} messages from overlay`);
                        }
                    } catch (error) {
                        console.error('Error parsing transferred chat history:', error);
                    }
                }
                
                // Render chat history
                renderChatHistory();
                
                // Initialize chat input features
                initializeChatInput();
                
            } catch (error) {
                console.error('Error initializing chat:', error);
            }
        }
        
        function initializeChatInput() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            
            if (!chatInput) return;
            
            // Auto-resize chat input
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 160) + 'px';
            });
            
            // Send message on Enter (but allow Shift+Enter for new line)
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    sendChatMessage();
                    return false;
                }
            });
            
            // Backup keypress handler for maximum compatibility
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    sendChatMessage();
                    return false;
                }
            });
            
            // Update send button state based on input
            chatInput.addEventListener('input', function() {
                const hasText = this.value.trim().length > 0;
                sendBtn.disabled = !hasText;
            });
            
            // Initial state
            sendBtn.disabled = true;
        }
        
        function renderChatHistory() {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            // Clear existing messages except the initial AI greeting
            messagesContainer.innerHTML = '';
            
            // Add initial AI greeting if no chat history
            if (chatHistory.length === 0) {
                const greeting = document.createElement('div');
                greeting.className = 'chat-message ai-message';
                greeting.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">Hello! I'm your AI assistant. I can help answer questions about this session. Ask me anything!</div>
                    </div>
                `;
                messagesContainer.appendChild(greeting);
            } else {
                // Render existing chat history
                chatHistory.forEach(message => {
                    addChatMessageToUI(message.sender, message.message, message.timestamp, false);
                });
            }
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function handleChatSubmit(event) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            sendChatMessage();
            return false;
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            
            if (!chatInput || !sendBtn) return;
            
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Clear input immediately for responsive feedback
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // Disable input and button
            chatInput.disabled = true;
            sendBtn.disabled = true;
            
            // Add user message to UI and history
            const userMessage = {
                id: Date.now() + Math.random(),
                sender: 'user',
                message: message,
                timestamp: new Date()
            };
            
            chatHistory.push(userMessage);
            addChatMessageToUI('user', message, new Date(), true);
            
            // Add thinking indicator
            const thinkingMessage = addThinkingMessage();
            
            try {
                // Prepare context with chat history and transcription
                const context = prepareChatContext(message);
                
                // Call AI service
                if (window.electronAPI && window.electronAPI.chatWithAI) {
                    const result = await window.electronAPI.chatWithAI(context);
                    
                    // Remove thinking indicator
                    thinkingMessage.remove();
                    
                    if (result.success) {
                        // Add AI response to UI and history
                        const aiMessage = {
                            id: Date.now() + Math.random(),
                            sender: 'ai',
                            message: result.message,
                            timestamp: new Date()
                        };
                        
                        chatHistory.push(aiMessage);
                        addChatMessageToUI('ai', result.message, new Date(), true);
                        
                        // Save chat history to Firebase
                        await saveChatHistory();
                        
                    } else {
                        throw new Error(result.error || 'Failed to get AI response');
                    }
                } else {
                    throw new Error('AI chat service not available');
                }
                
            } catch (error) {
                console.error('Error sending chat message:', error);
                
                // Remove thinking indicator
                thinkingMessage.remove();
                
                // Add error message
                const errorMessage = {
                    id: Date.now() + Math.random(),
                    sender: 'ai',
                    message: 'Sorry, I encountered an error. Please try again.',
                    timestamp: new Date()
                };
                
                chatHistory.push(errorMessage);
                addChatMessageToUI('ai', 'Sorry, I encountered an error. Please try again.', new Date(), true);
                
            } finally {
                // Re-enable input and button
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }
        
        function addChatMessageToUI(sender, message, timestamp, scrollToBottom = false) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender}-message`;
            
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${message}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            
            if (scrollToBottom) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        function addThinkingMessage() {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            const thinkingElement = document.createElement('div');
            thinkingElement.className = 'chat-message ai-message chat-thinking';
            thinkingElement.innerHTML = `
                <div class="message-content">
                    <div class="message-text">Thinking</div>
                </div>
            `;
            
            messagesContainer.appendChild(thinkingElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return thinkingElement;
        }
        
        function prepareChatContext(currentMessage) {
            // Build context with session transcript
            let context = `Session: ${sessionData.title}\n\n`;
            
            // Add transcript context
            if (sessionData.transcript && sessionData.transcript.length > 0) {
                context += 'Transcript:\n';
                context += sessionData.transcript
                    .map(entry => `[${entry.timestamp}] ${entry.text}`)
                    .join('\n');
                context += '\n\n';
            }
            
            // Add recent chat history for context (last 5 messages)
            if (chatHistory.length > 1) {
                context += 'Recent conversation:\n';
                const recentMessages = chatHistory.slice(-5, -1); // Exclude current message
                recentMessages.forEach(msg => {
                    context += `${msg.sender}: ${msg.message}\n`;
                });
                context += '\n';
            }
            
            // Add current user message
            context += `user: ${currentMessage}`;
            
            return context;
        }
        
        async function saveChatHistory() {
            try {
                if (sessionData.id && sessionData.id !== 'demo' && window.electronAPI && window.electronAPI.saveChatHistory) {
                    const result = await window.electronAPI.saveChatHistory(sessionData.id, chatHistory);
                    if (result.success) {
                        console.log('Chat history saved to Firebase');
                    } else {
                        console.error('Failed to save chat history:', result.error);
                    }
                }
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }
        
        async function clearChat() {
            const confirmed = await showConfirm('Are you sure you want to clear the chat history? This action cannot be undone?', {
                title: 'Clear Chat History',
                confirmText: 'Clear History',
                cancelText: 'Cancel',
                type: 'warning'
            });
            
            if (!confirmed) {
                return;
            }
            
            try {
                // Clear local chat history
                chatHistory = [];
                
                // Clear UI
                renderChatHistory();
                
                // Clear from Firebase
                if (sessionData.id && sessionData.id !== 'demo' && window.electronAPI && window.electronAPI.clearChatHistory) {
                    const result = await window.electronAPI.clearChatHistory(sessionData.id);
                    if (result.success) {
                        console.log('Chat history cleared from Firebase');
                } else {
                        console.error('Failed to clear chat history from Firebase:', result.error);
                    }
                }
                
                console.log('Chat history cleared');
                
            } catch (error) {
                console.error('Error clearing chat history:', error);
                showError('Failed to clear chat history. Please try again.');
            }
        }

        async function generateNotes() {
            const generateBtn = document.getElementById('generate-notes-btn');
            const originalText = generateBtn.innerHTML;
            const progressDiv = document.getElementById('notes-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const placeholder = document.getElementById('notes-placeholder');
            const sectionsDiv = document.getElementById('notes-sections');
            
            try {
                // Show loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                        <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/>
                    </svg>
                    Generating...
                `;
                
                // Hide placeholder and show progress
                placeholder.style.display = 'none';
                progressDiv.style.display = 'block';
                sectionsDiv.style.display = 'block';
                sectionsDiv.innerHTML = ''; // Clear previous notes
                
                // Prepare transcription text
                const transcriptionText = sessionData.transcript
                    .map(entry => `[${entry.timestamp}] ${entry.text}`)
                    .join('\n');
                
                if (!transcriptionText.trim()) {
                    throw new Error('No transcription data available to generate notes');
                }
                
                // Chunk the transcription
                const chunks = chunkTranscriptionByChars(transcriptionText, 500); // 500 characters per chunk
                console.log(`🔄 Processing ${chunks.length} chunks...`);
                
                // Calculate total characters and average chunk size
                const totalChars = transcriptionText.length;
                const avgChunkSize = totalChars / chunks.length;
                console.log(`📏 Total transcription: ${totalChars} characters`);
                console.log(`📊 Average chunk size: ${Math.round(avgChunkSize)} characters`);
                
                // Collect all notes from chunks
                const allNotesSections = [];
                
                // Process each chunk
                for (let i = 0; i < chunks.length; i++) {
                    const chunkIndex = i + 1;
                    const chunk = chunks[i];
                    
                    // Print chunk character length
                    console.log(`📊 Chunk ${chunkIndex}/${chunks.length}: ${chunk.length} characters`);
                    console.log(`📝 Chunk ${chunkIndex} preview:`, chunk.substring(0, 100) + '...');
                    
                    // Update progress
                    const progress = (chunkIndex / chunks.length) * 100;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `Processing chunk ${chunkIndex} of ${chunks.length} (${chunk.length} chars)...`;
                    
                    // Generate notes for this chunk
                    const chunkNotes = await generateChunkNotes(chunk, chunkIndex, chunks.length);
                    
                    // Collect notes instead of immediately displaying
                    if (chunkNotes) {
                        allNotesSections.push(chunkNotes);
                    }
                    
                    // Add small delay between chunks to show progress
                    if (i < chunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Hide progress bar
                progressDiv.style.display = 'none';
                
                // Combine all notes into one comprehensive document
                const combinedNotes = combineNoteSections(allNotesSections);
                
                // Display the combined notes as a single section
                if (combinedNotes) {
                    // Update local session data
                    sessionData.notes = [combinedNotes];
                    
                    addCombinedNoteSection(combinedNotes);
                    
                    // Save notes to Firebase
                    if (sessionData.id && sessionData.id !== 'demo') {
                        const saveResult = await window.electronAPI.saveNotes(sessionData.id, [combinedNotes]);
                        if (saveResult.success) {
                            console.log('Notes saved to Firebase');
                        } else {
                            console.error('Failed to save notes to Firebase:', saveResult.error);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error generating notes:', error);
                showError(`Failed to generate notes: ${error.message}`);
                
                // Show placeholder again on error
                placeholder.style.display = 'block';
                progressDiv.style.display = 'none';
                sectionsDiv.style.display = 'none';
                
            } finally {
                // Restore button state
                generateBtn.disabled = false;
                
                // Update button text based on whether we have notes now
                if (sessionData.notes && sessionData.notes.length > 0) {
                    generateBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Regenerate Notes
                    `;
                } else {
                    generateBtn.innerHTML = originalText;
                }
            }
        }

        function chunkTranscriptionByChars(text, maxChars) {
            const chunks = [];
            
            for (let i = 0; i < text.length; i += maxChars) {
                let chunk = text.slice(i, i + maxChars);
                
                // If we're not at the end and the chunk doesn't end with a space,
                // try to break at the last space to avoid cutting words in half
                if (i + maxChars < text.length && chunk[chunk.length - 1] !== ' ') {
                    const lastSpaceIndex = chunk.lastIndexOf(' ');
                    if (lastSpaceIndex > maxChars * 0.7) { // Only break if space is not too far back
                        chunk = chunk.substring(0, lastSpaceIndex);
                        i = i + lastSpaceIndex - maxChars + 1; // Adjust index for next iteration
                    }
                }
                
                chunks.push(chunk.trim());
            }
            
            return chunks.filter(chunk => chunk.length > 0);
        }

        async function generateChunkNotes(chunkText, chunkIndex, totalChunks) {
            try {
                if (window.electronAPI && window.electronAPI.generateNotes) {
                    const result = await window.electronAPI.generateNotes(chunkText, chunkIndex, totalChunks);
                    
                    if (result.success) {
                        return result.notes;
                    } else {
                        throw new Error(result.error || `Failed to generate notes for chunk ${chunkIndex}`);
                    }
                } else {
                    // Fallback demo notes when API not available
                    return generateDemoNotes(chunkIndex);
                }
                
            } catch (error) {
                console.error(`Error generating notes for chunk ${chunkIndex}:`, error);
                return generateDemoNotes(chunkIndex);
            }
        }

        function generateDemoNotes(chunkIndex) {
            // Demo notes for testing when API is not available
            const demoNotes = [
                {
                    title: "Introduction and Overview",
                    content: `
                        <h4>Key Concepts:</h4>
                        <ul>
                            <li>Data science definition and scope</li>
                            <li>Interdisciplinary nature of the field</li>
                            <li>Historical context and evolution</li>
                        </ul>
                        <h4>Important Points:</h4>
                        <ul>
                            <li>Data science combines statistics, computer science, and domain expertise</li>
                            <li>Modern data science emerged with the big data revolution</li>
                            <li>Think of it as detective work with data as evidence</li>
                        </ul>
                    `
                },
                {
                    title: "CRISP-DM Methodology",
                    content: `
                        <h4>Six Phases:</h4>
                        <ul>
                            <li>Business Understanding - Define problem and success criteria</li>
                            <li>Data Understanding - Explore and examine available data</li>
                            <li>Data Preparation - Clean and transform data (60-80% of time)</li>
                            <li>Modeling - Apply statistical and ML algorithms</li>
                            <li>Evaluation - Assess model performance and validity</li>
                            <li>Deployment - Implement in production environment</li>
                        </ul>
                    `
                },
                {
                    title: "Essential Skills and Tools",
                    content: `
                        <h4>Technical Skills:</h4>
                        <ul>
                            <li>Programming: Python (pandas, NumPy, scikit-learn), R, SQL</li>
                            <li>Statistics: Probability, hypothesis testing, experimental design</li>
                            <li>Machine Learning: Supervised, unsupervised, reinforcement learning</li>
                        </ul>
                        <h4>Soft Skills:</h4>
                        <ul>
                            <li>Analytical thinking and problem-solving</li>
                            <li>Communication and data visualization</li>
                            <li>Domain expertise in specific industries</li>
                        </ul>
                    `
                }
            ];
            
            return demoNotes[Math.min(chunkIndex - 1, demoNotes.length - 1)];
        }

        function combineNoteSections(notesSections) {
            if (!notesSections || notesSections.length === 0) {
                return null;
            }
            
            // Create a comprehensive title
            const mainTitle = sessionData.title + " - Comprehensive Notes";
            
            // Combine all content sections
            let combinedContent = '<div class="combined-notes-intro">';
            combinedContent += '<p><em>AI-generated comprehensive notes from session transcript</em></p>';
            combinedContent += '</div>';
            
            // Add each section's content with section headers
            notesSections.forEach((section, index) => {
                combinedContent += `<div class="note-subsection">`;
                combinedContent += `<h3 class="subsection-title">${section.title}</h3>`;
                combinedContent += `<div class="subsection-content">${section.content}</div>`;
                combinedContent += `</div>`;
            });
            
            return {
                title: mainTitle,
                content: combinedContent
            };
        }
        
        function addCombinedNoteSection(combinedNotes) {
            const sectionsDiv = document.getElementById('notes-sections');
            
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'note-section combined-notes';
            sectionDiv.innerHTML = `
                <div class="note-section-header">
                    <h3 class="note-section-title">${combinedNotes.title}</h3>
                    <span class="note-section-timestamp">Complete Notes</span>
                </div>
                <div class="note-section-content">
                    ${combinedNotes.content}
                </div>
            `;
            
            sectionsDiv.appendChild(sectionDiv);
            
            // Scroll to the section
            sectionDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            console.log('✅ Combined notes displayed successfully');
        }

        async function generateSummary() {
            const generateBtn = document.getElementById('generate-summary-btn');
            const originalText = generateBtn.innerHTML;
            const progressDiv = document.getElementById('summary-progress');
            const progressFill = document.getElementById('summary-progress-fill');
            const progressText = document.getElementById('summary-progress-text');
            const placeholder = document.getElementById('summary-placeholder');
            const sectionsDiv = document.getElementById('summary-sections');
            
            try {
                // Show loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                        <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/>
                    </svg>
                    Analyzing...
                `;
                
                // Hide placeholder and show progress
                placeholder.style.display = 'none';
                progressDiv.style.display = 'block';
                
                // Prepare transcription text
                const transcriptionText = sessionData.transcript
                    .map(entry => `[${entry.timestamp}] ${entry.text}`)
                    .join('\n');
                
                if (!transcriptionText.trim()) {
                    throw new Error('No transcription data available to generate summary');
                }
                
                console.log(`🔄 Generating AI summary for ${transcriptionText.length} character transcript...`);
                
                // Animate progress
                progressText.textContent = 'Analyzing transcript content...';
                progressFill.style.width = '30%';
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                progressText.textContent = 'Extracting key insights...';
                progressFill.style.width = '60%';
                
                // Generate summary using AI
                const summaryResult = await generateAISummary(transcriptionText);
                
                progressText.textContent = 'Formatting results...';
                progressFill.style.width = '90%';
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Hide progress bar
                progressDiv.style.display = 'none';
                
                // Display summary
                if (summaryResult) {
                    displayAISummary(summaryResult);
                    sectionsDiv.style.display = 'block';
                }
                
                progressFill.style.width = '100%';
                console.log('✅ Summary generated successfully');
                
                // Update button text to show regeneration option
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Regenerate Summary
                `;
                
            } catch (error) {
                console.error('Error generating summary:', error);
                showError(`Failed to generate summary: ${error.message}`);
                
                // Show placeholder again on error
                placeholder.style.display = 'block';
                progressDiv.style.display = 'none';
                
            } finally {
                // Restore button state
                generateBtn.disabled = false;
                
                // Only restore original text if we don't have a summary (which would mean generation failed)
                if (!sessionData.summary || !sessionData.summary.trim()) {
                    generateBtn.innerHTML = originalText;
                }
            }
        }

        async function generateAISummary(transcriptionText) {
            try {
                if (window.electronAPI && window.electronAPI.generateSummary) {
                    const result = await window.electronAPI.generateSummary(transcriptionText);
                    
                    if (result.success) {
                        // Update local session data
                        sessionData.summary = result.summary.overview;
                        sessionData.keyPoints = result.summary.keyPoints;
                        sessionData.actionItems = result.summary.actionItems;
                        
                        // Save summary to Firebase
                        if (sessionData.id && sessionData.id !== 'demo') {
                            const saveResult = await window.electronAPI.saveSummary(
                                sessionData.id, 
                                result.summary.overview,
                                result.summary.keyPoints,
                                result.summary.actionItems
                            );
                            if (saveResult.success) {
                                console.log('Summary saved to Firebase');
                            } else {
                                console.error('Failed to save summary to Firebase:', saveResult.error);
                            }
                        }
                        
                        return result.summary;
                    } else {
                        throw new Error(result.error || 'Failed to generate summary');
                    }
                } else {
                    // Fallback demo summary when API not available
                    return generateDemoSummary();
                }
                
            } catch (error) {
                console.error('Error generating AI summary:', error);
                const demoSummary = generateDemoSummary();
                
                // Update local session data even for demo
                sessionData.summary = demoSummary.overview;
                sessionData.keyPoints = demoSummary.keyPoints;
                sessionData.actionItems = demoSummary.actionItems;
                
                return demoSummary;
            }
        }

        function generateDemoSummary() {
            // Demo summary for testing when API is not available
            return {
                overview: "This comprehensive lecture introduces data science as an interdisciplinary field combining statistics, mathematics, computer science, and domain expertise. Dr. Sarah Mitchell covers the historical evolution, CRISP-DM methodology, essential skills, real-world applications, and career guidance for aspiring data scientists.",
                keyPoints: [
                    "Definition: Data science combines statistics, mathematics, computer science, and domain expertise to extract meaningful insights",
                    "Methodology: CRISP-DM provides a structured 6-phase approach from business understanding through deployment",
                    "Technical Skills: Python and R are the dominant programming languages with extensive data science ecosystems",
                    "Process Reality: Data preparation typically consumes 60-80% of a data scientist's time in real projects",
                    "Communication: Translating technical findings to stakeholders is crucial for business impact",
                    "Domain Knowledge: Industry expertise significantly enhances analysis value and interpretation accuracy",
                    "Applications: Real-world use cases span healthcare diagnostics, business intelligence, and environmental modeling"
                ],
                actionItems: [
                    "Start learning Python fundamentals and data science libraries",
                    "Build a strong foundation in statistics and probability theory",
                    "Practice with real datasets on platforms like Kaggle",
                    "Develop a portfolio of data science projects",
                    "Focus on developing communication and visualization skills"
                ],
                topics: [
                    "Data Science Definition",
                    "CRISP-DM Methodology",
                    "Programming Skills",
                    "Statistical Knowledge",
                    "Machine Learning",
                    "Healthcare Applications",
                    "Business Intelligence",
                    "Career Paths",
                    "Industry Trends",
                    "Ethics in AI"
                ]
            };
        }

        function displayAISummary(summary) {
            // Display overview
            document.getElementById('ai-summary-text').textContent = summary.overview;
            
            // Display key points as organized bullet points and action items as paragraph
            const keyPointsDiv = document.getElementById('ai-key-points');
            let combinedContent = '';
            
            // Add key points section as bullet points
            if (summary.keyPoints && summary.keyPoints.length > 0) {
                combinedContent += '<h4>Key Insights</h4>';
                combinedContent += '<ul class="insights-list">';
                summary.keyPoints.forEach(point => {
                    combinedContent += `<li>${point}</li>`;
                });
                combinedContent += '</ul>';
            }
            
            // Add action items section as paragraph
            if (summary.actionItems && summary.actionItems.length > 0) {
                combinedContent += '<h4>Recommended Actions</h4>';
                combinedContent += '<p>' + summary.actionItems.join('. ') + '.</p>';
            }
            
            keyPointsDiv.innerHTML = combinedContent;
            
            // Display topics as simple bullet points
            const topicsList = document.getElementById('ai-topics');
            topicsList.innerHTML = summary.topics.map(topic => `<li>${topic}</li>`).join('');
        }

        function addNoteSection(notes, chunkIndex) {
            const sectionsDiv = document.getElementById('notes-sections');
            
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'note-section';
            sectionDiv.innerHTML = `
                <div class="note-section-header">
                    <h3 class="note-section-title">${notes.title}</h3>
                    <span class="note-section-timestamp">Section ${chunkIndex}</span>
                </div>
                <div class="note-section-content">
                    ${notes.content}
                </div>
            `;
            
            sectionsDiv.appendChild(sectionDiv);
            
            // Scroll to the new section
            sectionDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function exportAnki() {
            try {
                if (!sessionData.flashcards || sessionData.flashcards.length === 0) {
                    showWarning('No flashcards available to export. Please generate flashcards first.');
                    return;
                }

                const exportBtn = event.target;
                const originalText = exportBtn.innerHTML;
                
                // Show loading state
                exportBtn.disabled = true;
                exportBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                        <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/>
                    </svg>
                    Exporting...
                `;

                // Generate Anki text format (Anki can import from tab-separated text files)
                const ankiData = generateAnkiTextFormat(sessionData.flashcards, sessionData.title);
                
                // Create and download the file
                const blob = new Blob([ankiData], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sanitizeFilename(sessionData.title)}_flashcards.txt`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Restore button
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;

            } catch (error) {
                console.error('Error exporting to Anki:', error);
                showError(`Failed to export flashcards: ${error.message}`);
                
                // Restore button on error
                const exportBtn = event.target;
                exportBtn.disabled = false;
                exportBtn.innerHTML = exportBtn.dataset.originalText || 'Export to Anki';
            }
        }

        function generateAnkiTextFormat(flashcards, sessionTitle) {
            // Anki import format: Front\tBack\tTags
            let ankiText = '';
            
            // Add header comment
            ankiText += `# Anki Flashcards Export\n`;
            ankiText += `# Generated from: ${sessionTitle}\n`;
            ankiText += `# Date: ${new Date().toLocaleDateString()}\n`;
            ankiText += `# Total cards: ${flashcards.length}\n`;
            ankiText += `# Import instructions: File → Import → Select this file → Check "Allow HTML in fields" → Import\n\n`;
            
            // Generate flashcards in tab-separated format
            flashcards.forEach((card, index) => {
                // Clean and format the question and answer
                const question = cleanTextForAnki(card.question);
                const answer = cleanTextForAnki(card.answer);
                const tags = sanitizeFilename(sessionTitle).replace(/\s+/g, '_').toLowerCase();
                
                // Format: Front\tBack\tTags
                ankiText += `${question}\t${answer}\t${tags}\n`;
            });
            
            return ankiText;
        }

        function cleanTextForAnki(text) {
            // Clean text for Anki import while preserving basic formatting
            return text
                .replace(/\t/g, ' ')        // Replace tabs with spaces
                .replace(/\n+/g, '<br>')    // Convert newlines to HTML breaks
                .replace(/"/g, '&quot;')    // Escape quotes
                .trim();
        }

        function sanitizeFilename(filename) {
            // Remove or replace invalid filename characters
            return filename
                .replace(/[<>:"/\\|?*]/g, '_')  // Replace invalid chars with underscore
                .replace(/\s+/g, '_')           // Replace spaces with underscore
                .replace(/_+/g, '_')            // Replace multiple underscores with single
                .slice(0, 100);                // Limit length
        }

        async function exportQuizlet() {
            try {
                if (!sessionData.flashcards || sessionData.flashcards.length === 0) {
                    showWarning('No flashcards available to export. Please generate flashcards first.');
                    return;
                }

                const exportBtn = event.target;
                const originalText = exportBtn.innerHTML;
                
                // Show loading state
                exportBtn.disabled = true;
                exportBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                        <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/>
                    </svg>
                    Exporting...
                `;

                // Generate Quizlet text format
                const quizletData = generateQuizletTextFormat(sessionData.flashcards, sessionData.title);
                
                // Create and download the file
                const blob = new Blob([quizletData], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sanitizeFilename(sessionData.title)}_quizlet.txt`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Restore button
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;

            } catch (error) {
                console.error('Error exporting to Quizlet:', error);
                showError(`Failed to export flashcards: ${error.message}`);
                
                // Restore button on error
                const exportBtn = event.target;
                exportBtn.disabled = false;
                exportBtn.innerHTML = exportBtn.dataset.originalText || 'Export to Quizlet';
            }
        }

        function generateQuizletTextFormat(flashcards, sessionTitle) {
            // Quizlet import format: Term\tDefinition (tab-separated)
            let quizletText = '';
            
            // Add header comment (Quizlet will ignore lines starting with #)
            quizletText += `# Quizlet Study Set Export\n`;
            quizletText += `# Generated from: ${sessionTitle}\n`;
            quizletText += `# Date: ${new Date().toLocaleDateString()}\n`;
            quizletText += `# Total terms: ${flashcards.length}\n\n`;
            
            // Generate flashcards in tab-separated format
            flashcards.forEach((card) => {
                // Clean and format the question and answer for Quizlet
                const term = cleanTextForQuizlet(card.question);
                const definition = cleanTextForQuizlet(card.answer);
                
                // Format: Term\tDefinition
                quizletText += `${term}\t${definition}\n`;
            });
            
            return quizletText;
        }

        function cleanTextForQuizlet(text) {
            // Clean text for Quizlet import (simpler than Anki)
            return text
                .replace(/\t/g, ' ')      // Replace tabs with spaces
                .replace(/\n+/g, ' ')     // Replace newlines with spaces (Quizlet uses single line)
                .replace(/\s+/g, ' ')     // Normalize whitespace
                .trim();
        }

        function viewScreenshot(id) {
            showInfo(`Viewing screenshot ${id}... This will open a modal or new window.`);
        }

        function flipCard(index) {
            // TODO: Implement card flip animation
            console.log('Flipping card', index);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }



        // Initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.setAttribute('data-theme', 'dark');
            }
        }

        // Initialize the page
        window.addEventListener('DOMContentLoaded', async () => {
            initializeTheme();
            await initializePage();
        });

        function showAddFlashcardModal() {
            currentEditingIndex = null;
            document.getElementById('addFlashcardModal').classList.add('active');
            // Clear form fields
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            // Update modal for adding
            document.getElementById('modal-title').textContent = 'Add Flashcard';
            document.querySelector('.modal-actions button[type="submit"]').textContent = 'Add Flashcard';
            // Focus on question input
            setTimeout(() => {
                document.getElementById('question').focus();
            }, 300);
            // Add keyboard event listener for Escape key
            document.addEventListener('keydown', handleModalKeydown);
        }

        function editFlashcard(index, event) {
            // Stop the card flip event from firing
            event.stopPropagation();
            
            currentEditingIndex = index;
            const card = sessionData.flashcards[index];
            
            document.getElementById('addFlashcardModal').classList.add('active');
            // Fill form fields with current card data
            document.getElementById('question').value = card.question;
            document.getElementById('answer').value = card.answer;
            // Update modal for editing
            document.getElementById('modal-title').textContent = 'Edit Flashcard';
            document.querySelector('.modal-actions button[type="submit"]').textContent = 'Save Changes';
            // Focus on question input
            setTimeout(() => {
                document.getElementById('question').focus();
            }, 300);
            // Add keyboard event listener for Escape key
            document.addEventListener('keydown', handleModalKeydown);
        }

        function closeAddFlashcardModal() {
            document.getElementById('addFlashcardModal').classList.remove('active');
            // Clear form fields
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            // Reset editing state
            currentEditingIndex = null;
            // Remove keyboard event listener
            document.removeEventListener('keydown', handleModalKeydown);
        }

        function handleModalKeydown(event) {
            if (event.key === 'Escape') {
                closeAddFlashcardModal();
            }
        }

        function handleAddFlashcardSubmit(event) {
            event.preventDefault();
            addFlashcard();
        }

        async function addFlashcard() {
            const questionInput = document.getElementById('question');
            const answerInput = document.getElementById('answer');
            const question = questionInput.value.trim();
            const answer = answerInput.value.trim();
            
            if (!question || !answer) {
                showWarning('Please fill in both question and answer fields.');
                return;
            }
            
            try {
                // Initialize flashcards array if needed
                if (!sessionData.flashcards) {
                    sessionData.flashcards = [];
                }
                
                if (currentEditingIndex !== null) {
                    // Edit existing flashcard
                    sessionData.flashcards[currentEditingIndex] = { question, answer };
                    console.log('✅ Flashcard updated successfully');
                } else {
                    // Add new flashcard
                    sessionData.flashcards.push({ question, answer });
                    console.log('✅ Flashcard added successfully');
                }
                
                // Save to Firebase if available
                if (sessionData.id && sessionData.id !== 'demo' && window.electronAPI && window.electronAPI.saveFlashcards) {
                    const saveResult = await window.electronAPI.saveFlashcards(sessionData.id, sessionData.flashcards);
                    if (saveResult.success) {
                        console.log('Flashcards saved to Firebase');
                    } else {
                        console.error('Failed to save flashcards to Firebase:', saveResult.error);
                    }
                }
                
                // Update UI
                checkFlashcards();
                closeAddFlashcardModal();
                
            } catch (error) {
                console.error('Error saving flashcard:', error);
                showError('Failed to save flashcard. Please try again.');
            }
        }

        async function deleteFlashcard(index, event) {
            // Stop ALL event propagation to prevent modal issues
            event.stopPropagation();
            event.stopImmediatePropagation();
            event.preventDefault();
            
            console.log('🗑️ Delete flashcard triggered for index:', index);
            
            const card = sessionData.flashcards[index];
            let confirmDelete = false;
            
            try {
                console.log('💬 Showing delete confirmation dialog...');
                
                // Small delay to ensure click event is fully processed
                await new Promise(resolve => setTimeout(resolve, 50));
                
                confirmDelete = await showConfirm(`Are you sure you want to delete this flashcard?\n\nQuestion: ${card.question}`, {
                    title: 'Delete Flashcard',
                    confirmText: 'Delete',
                    cancelText: 'Cancel',
                    type: 'warning',
                    confirmType: 'danger'
                });
                console.log('💬 Delete confirmation result:', confirmDelete);
            } catch (confirmError) {
                console.error('Error with showConfirm:', confirmError);
                // Fallback to browser confirm dialog
                confirmDelete = confirm(`Are you sure you want to delete this flashcard?\n\nQuestion: ${card.question}`);
                console.log('💬 Fallback confirmation result:', confirmDelete);
            }
            
            if (!confirmDelete) {
                console.log('❌ Delete cancelled by user');
                return;
            }
            
            try {
                // Remove from local data
                sessionData.flashcards.splice(index, 1);
                
                // Save to Firebase if available
                if (sessionData.id && sessionData.id !== 'demo' && window.electronAPI && window.electronAPI.saveFlashcards) {
                    const saveResult = await window.electronAPI.saveFlashcards(sessionData.id, sessionData.flashcards);
                    if (saveResult.success) {
                        console.log('Flashcard deleted from Firebase');
                    } else {
                        console.error('Failed to delete flashcard from Firebase:', saveResult.error);
                    }
                }
                
                // Update UI
                checkFlashcards();
                
                console.log('✅ Flashcard deleted successfully');
                
            } catch (error) {
                console.error('Error deleting flashcard:', error);
                try {
                    showError('Failed to delete flashcard. Please try again.');
                } catch (notificationError) {
                    console.error('Error with notification system:', notificationError);
                    alert('Failed to delete flashcard. Please try again.');
                }
            }
        }
    </script>
    <script src="../../utils/notification-system.js"></script>
</body>
</html> 